<!DOCTYPE html>
<html>
<head>
    <title>Text File Processor</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h1>Text File Processor</h1>
        
        <div class="file-input-container">
            <input type="file" id="fileInput" accept=".txt,.csv,.json,.tsv">
            <button id="preprocessButton" disabled>Pre-Process File</button>
        </div>
        <div id="errorMessage" class="error" style="display: none;"></div>
        
        <h2>File Preview</h2>
        <div id="filePreview" class="preview"></div>
        
        <div class="results">
            <h2>Processing Results</h2>
            <div class="stats-container">
                <div id="tokenCount" class="stat-card"></div>
            </div>
            <div id="preprocessedPreview"></div>
        </div>
    </div>

    <script>
        let currentFileName = '';

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = message ? 'block' : 'none';
        }

        function showLoading(isLoading) {
            const button = document.getElementById('preprocessButton');
            button.textContent = isLoading ? 'Processing...' : 'Pre-Process File';
            button.disabled = isLoading;
        }

        document.getElementById('fileInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                showError('');
                const response = await fetch('/upload/', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail);
                }
                
                const data = await response.json();
                document.getElementById('filePreview').textContent = data.content;
                document.getElementById('preprocessButton').style.display = 'inline-block';
                document.getElementById('preprocessButton').disabled = false;
                currentFileName = data.filename;
            } catch (error) {
                showError(`Upload error: ${error.message}`);
                document.getElementById('filePreview').textContent = '';
                document.getElementById('preprocessButton').style.display = 'none';
            }
        });

        document.getElementById('preprocessButton').addEventListener('click', async () => {
            if (!currentFileName) return;

            try {
                showLoading(true);
                showError('');
                const response = await fetch(`/preprocess/${currentFileName}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Server error');
                }

                const data = await response.json();
                
                document.getElementById('tokenCount').innerHTML = `
                    <h5>Token Statistics</h5>
                    <p>Total tokens: ${data.num_tokens}</p>
                `;
                
                document.getElementById('preprocessedPreview').innerHTML = `
                    <h3>Line-by-Line Analysis</h3>
                    <table class="analysis-table">
                        <tr>
                            <th>Line #</th>
                            <th>Original Text</th>
                            <th>NLTK Tokens</th>
                            <th>BERT Tokens</th>
                            <th>NLTK Count</th>
                            <th>BERT Count</th>
                        </tr>
                        ${data.line_stats.map(line => `
                            <tr>
                                <td>${line.line_number}</td>
                                <td>${line.original_text}</td>
                                <td>${line.nltk_tokens.join(' ')}</td>
                                <td>${line.bert_tokens.join(' ')}</td>
                                <td>${line.token_count.nltk}</td>
                                <td>${line.token_count.bert}</td>
                            </tr>
                            ${line.embeddings && line.embeddings.tokens ? `
                            <tr class="embeddings-row">
                                <td colspan="6">
                                    <div class="embeddings-container">
                                        <strong>BERT Embeddings (first 5 tokens, first 10 dimensions)</strong>
                                        ${line.embeddings.tokens.map((token, idx) => `
                                            <div class="token-vector">
                                                <strong>${token}:</strong> 
                                                <span class="vector-value">[${line.embeddings.vectors[idx].join(', ')}]</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </td>
                            </tr>
                            ` : ''}
                        `).join('')}
                    </table>

                    <div class="stats-container">
                        <div class="stat-card">
                            <h5>Padding Information</h5>
                            <p>Original length: ${data.padding_info.original_length} tokens</p>
                            <p>Maximum length: ${data.padding_info.max_length} tokens</p>
                            <p>Final length: ${data.padding_info.final_length} tokens</p>
                            <p>Was padded: ${data.padding_info.is_padded ? 'Yes' : 'No'}</p>
                            <p>Was truncated: ${data.padding_info.is_truncated ? 'Yes' : 'No'}</p>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Processing error:', error);
                showError(`Processing error: ${error.message}`);
                document.getElementById('preprocessedPreview').innerHTML = '';
                document.getElementById('tokenCount').innerHTML = '';
            } finally {
                showLoading(false);
            }
        });
    </script>
</body>
</html> 